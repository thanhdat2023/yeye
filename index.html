<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Web H·ªçc T·∫≠p</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f5f5f5;
  margin: 0;
  text-align: center;
}
h1,h2 { margin: 20px; }
button {
  margin: 4px;
  padding: 6px 14px;
  font-size: 14px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}
.subject, .doc, .task {
  background: #fff;
  border-radius: 12px;
  padding: 10px;
  margin: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
.subject:hover, .doc:hover { background: #ffe4ec; }
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px,1fr));
  gap: 10px;
  padding: 10px;
}
video, canvas {
  width: 100%;
  max-width: 400px;
  margin: 10px auto;
  border-radius: 12px;
  background: #000;
}
img {
  width: 90%;
  max-width: 280px;
  margin: 8px auto;
  border-radius: 10px;
  display:block;
}
.task-list {
  max-width: 400px;
  margin: 10px auto;
  text-align: left;
}
.task.overdue { background: #ffcccc; }
.hidden { display: none; }

/* Modal */
.modal {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
}
.modal-content {
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  text-align: center;
  width: 300px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}
.modal.hidden { display: none; }

#previewList img {
  width:120px;
  margin:5px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.3);
}

/* Scan frame overlay */
#cameraWrapper {
  position: relative;
  display: inline-block;
}
#video {
  width: 90%;
  max-width: 500px;
  aspect-ratio: 3/4;
  border-radius: 12px;
  object-fit: cover;
  background: #000;
}
.scan-frame {
  position: absolute;
  top: 0; left: 50%;
  transform: translateX(-50%);
  width: 90%;
  max-width: 500px;
  aspect-ratio: 3/4;
  border: 4px solid limegreen;
  border-radius: 12px;
  box-shadow: 0 0 15px rgba(0,255,0,0.5);
  pointer-events: none;
  animation: pulse 2s infinite;
}
@keyframes pulse {
  0% { border-color: limegreen; box-shadow: 0 0 10px rgba(0,255,0,0.5); }
  50% { border-color: red; box-shadow: 0 0 15px rgba(255,0,0,0.6); }
  100% { border-color: limegreen; box-shadow: 0 0 10px rgba(0,255,0,0.5); }
}
</style>
</head>
<body>

<!-- Trang ch·ªß -->
<div id="home">
  <h1>Ch·ªçn m√¥n h·ªçc</h1>
  <div class="grid">
    <div class="subject" onclick="openSubject('To√°n')">üìê To√°n</div>
    <div class="subject" onclick="openSubject('Ng·ªØ VƒÉn')">üìñ Ng·ªØ VƒÉn</div>
    <div class="subject" onclick="openSubject('L·ªãch S·ª≠')">üìú L·ªãch S·ª≠</div>
    <div class="subject" onclick="openSubject('ƒê·ªãa L√Ω')">üåç ƒê·ªãa L√Ω</div>
    <div class="subject" onclick="openSubject('Sinh h·ªçc')">üß¨ Sinh h·ªçc</div>
    <div class="subject" onclick="openSubject('H√≥a h·ªçc')">‚öóÔ∏è H√≥a h·ªçc</div>
  </div>
</div>

<!-- Trang m√¥n h·ªçc -->
<div id="subjectPage" class="hidden">
  <h1 id="subjectTitle"></h1>

  <!-- Qu·∫£n l√Ω b√†i t·∫≠p -->
  <h2>üìí B√†i t·∫≠p v·ªÅ nh√†</h2>
  <input type="text" id="taskInput" placeholder="Nh·∫≠p t√™n b√†i t·∫≠p...">
  <input type="date" id="taskDeadline">
  <button onclick="addTask()">‚ûï Th√™m</button>
  <div id="taskList" class="task-list"></div>

  <!-- Qu·∫£n l√Ω t√†i li·ªáu -->
  <h2>üìë T√†i li·ªáu</h2>
  <button onclick="openNewDocDialog()">‚ûï T·∫°o t√†i li·ªáu m·ªõi</button>
  <div id="docList" class="grid"></div>

  <br>
  <button onclick="goHome()">‚¨Ö Quay l·∫°i</button>
</div>

<!-- Trang ch·ª•p ·∫£nh -->
<div id="cameraPage" class="hidden">
  <h2 id="docTitle"></h2>
  <div id="cameraWrapper">
    <video id="video" autoplay playsinline muted></video>
    <div class="scan-frame"></div>
  </div>
  <canvas id="canvas" class="hidden"></canvas>
  <div>
    <button onclick="takePhoto()">üì∏ Ch·ª•p</button>
    <button onclick="switchCamera()" id="switchBtn" class="hidden">üîÑ ƒê·ªïi camera</button>
    <button onclick="finishCapture()">‚úÖ Xong</button>
  </div>
  <div id="previewList"></div>
</div>

<!-- Trang xem t√†i li·ªáu -->
<div id="viewDocPage" class="hidden">
  <h2 id="viewDocTitle"></h2>
  <div id="photoList"></div>
  <button onclick="backToDocs()">‚¨Ö Quay l·∫°i</button>
</div>

<!-- Modal nh·∫≠p t√™n t√†i li·ªáu -->
<div id="newDocDialog" class="modal hidden">
  <div class="modal-content">
    <h3>üìë Nh·∫≠p t√™n t√†i li·ªáu</h3>
    <input type="text" id="docNameInput" placeholder="T√™n t√†i li·ªáu...">
    <br><br>
    <button onclick="createDocument()">T·∫°o</button>
    <button onclick="closeDialog()">H·ªßy</button>
  </div>
</div>

<!-- Modal x√°c nh·∫≠n x√≥a -->
<div id="deleteDocDialog" class="modal hidden">
  <div class="modal-content">
    <h3>üóë X√≥a t√†i li·ªáu</h3>
    <p id="deleteDocMessage"></p>
    <button onclick="confirmDeleteDoc()">X√≥a</button>
    <button onclick="closeDeleteDialog()">H·ªßy</button>
  </div>
</div>

<script>
let currentSubject = "";
let currentDocId = null;
let stream = null;
let docToDelete = null;
let usingFront = true; // m·∫∑c ƒë·ªãnh d√πng cam tr∆∞·ªõc

/* IndexedDB */
function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open("StudyApp", 1);
    request.onupgradeneeded = (e) => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains("documents")) {
        db.createObjectStore("documents", { keyPath: "id", autoIncrement: true });
      }
    };
    request.onsuccess = (e) => resolve(e.target.result);
    request.onerror = (e) => reject(e.target.error);
  });
}
async function getAllDocs() {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction("documents", "readonly");
    const store = tx.objectStore("documents");
    const request = store.getAll();
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}
async function addDoc(doc) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction("documents", "readwrite");
    const store = tx.objectStore("documents");
    const request = store.add(doc);
    request.onsuccess = () => resolve(request.result);
    request.onerror = (e) => reject(e.target.error);
  });
}
async function updateDoc(doc) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction("documents", "readwrite");
    const store = tx.objectStore("documents");
    const request = store.put(doc);
    request.onsuccess = () => resolve();
    request.onerror = (e) => reject(e.target.error);
  });
}
async function deleteDoc(id) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction("documents", "readwrite");
    const store = tx.objectStore("documents");
    const request = store.delete(id);
    request.onsuccess = () => resolve();
    request.onerror = (e) => reject(e.target.error);
  });
}
async function getDoc(id) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction("documents", "readonly");
    const store = tx.objectStore("documents");
    const request = store.get(id);
    request.onsuccess = () => resolve(request.result);
    request.onerror = (e) => reject(e.target.error);
  });
}

/* M√¥n h·ªçc */
async function openSubject(name) {
  currentSubject = name;
  document.getElementById("subjectTitle").innerText = "M√¥n: " + name;
  document.getElementById("home").classList.add("hidden");
  document.getElementById("subjectPage").classList.remove("hidden");
  loadTasks();
  showDocs();
}
function goHome() {
  document.getElementById("subjectPage").classList.add("hidden");
  document.getElementById("home").classList.remove("hidden");
}

/* B√†i t·∫≠p */
function addTask() {
  const taskText = document.getElementById("taskInput").value.trim();
  const deadline = document.getElementById("taskDeadline").value;
  if (!taskText || !deadline) { alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!"); return; }
  let tasks = JSON.parse(localStorage.getItem("tasks_" + currentSubject) || "[]");
  tasks.push({ text: taskText, deadline: deadline });
  localStorage.setItem("tasks_" + currentSubject, JSON.stringify(tasks));
  document.getElementById("taskInput").value = "";
  document.getElementById("taskDeadline").value = "";
  loadTasks();
}
function deleteTask(index) {
  let tasks = JSON.parse(localStorage.getItem("tasks_" + currentSubject) || "[]");
  tasks.splice(index, 1);
  localStorage.setItem("tasks_" + currentSubject, JSON.stringify(tasks));
  loadTasks();
}
function loadTasks() {
  let tasks = JSON.parse(localStorage.getItem("tasks_" + currentSubject) || "[]");
  const list = document.getElementById("taskList");
  list.innerHTML = "";
  const today = new Date().toISOString().split("T")[0];
  tasks.forEach((task,i) => {
    const div = document.createElement("div");
    div.classList.add("task");
    if (task.deadline < today) div.classList.add("overdue");
    div.innerHTML = `<b>${task.text}</b><br>H·∫°n: ${task.deadline} 
      <button onclick="deleteTask(${i})">‚ùå</button>`;
    list.appendChild(div);
  });
}

/* T√†i li·ªáu */
async function showDocs() {
  const list = document.getElementById("docList");
  list.innerHTML = "";
  const allDocs = await getAllDocs();
  const docs = allDocs.filter(d => d.subject === currentSubject);
  docs.forEach(doc=>{
    const div = document.createElement("div");
    div.className="doc";
    div.innerHTML = `
      <b>${doc.name}</b><br>
      (${doc.images.length} ·∫£nh)<br>
      <button onclick="viewDoc(${doc.id})">üëÅ Xem</button>
      <button onclick="openDeleteDialog(${doc.id}, '${doc.name}')">üóë Xo√°</button>
    `;
    list.appendChild(div);
  });
}
function openNewDocDialog() {
  document.getElementById("docNameInput").value="";
  document.getElementById("newDocDialog").classList.remove("hidden");
}
function closeDialog() {
  document.getElementById("newDocDialog").classList.add("hidden");
}
async function createDocument() {
  const name = document.getElementById("docNameInput").value.trim();
  if (!name) return;
  closeDialog();
  currentDocId = await addDoc({subject: currentSubject, name: name, images: []});
  document.getElementById("docTitle").innerText = "T√†i li·ªáu: " + name;
  document.getElementById("subjectPage").classList.add("hidden");
  document.getElementById("cameraPage").classList.remove("hidden");
  document.getElementById("previewList").innerHTML = ""; 
  openCamera();
}

/* Camera */
async function openCamera() {
  if (stream) stream.getTracks().forEach(t=>t.stop());
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: usingFront ? "user" : "environment",
        width: { ideal: 1280 },
        height: { ideal: 720 }
      }
    });
    const video = document.getElementById("video");
    video.srcObject = stream;
    await video.play(); // fix iPhone video ƒëen

    // N·∫øu ƒëang d√πng cam tr∆∞·ªõc -> l·∫≠t g∆∞∆°ng
    if (usingFront) {
      video.style.transform = "scaleX(-1)";
    } else {
      video.style.transform = "scaleX(1)";
    }

    // N·∫øu tr√™n ƒëi·ªán tho·∫°i -> hi·ªán n√∫t ƒë·ªïi camera
    if (/Mobi|Android|iPhone/i.test(navigator.userAgent)) {
      document.getElementById("switchBtn").classList.remove("hidden");
    } else {
      document.getElementById("switchBtn").classList.add("hidden");
    }
  } catch(err) {
    alert("Kh√¥ng th·ªÉ m·ªü camera: " + err);
  }
}
function switchCamera() {
  usingFront = !usingFront;
  openCamera();
}
async function takePhoto() {
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  // N·∫øu cam tr∆∞·ªõc th√¨ ph·∫£i l·∫≠t ·∫£nh l·∫°i (v√¨ ƒë√£ mirror preview)
  if (usingFront) {
    ctx.translate(canvas.width, 0);
    ctx.scale(-1, 1);
  }

  ctx.drawImage(video,0,0);
  const imgData = canvas.toDataURL("image/jpeg", 0.7);
  let doc = await getDoc(currentDocId);
  doc.images.push(imgData);
  await updateDoc(doc);
  showPreviewImages(doc.images);
}
function showPreviewImages(images) {
  const list = document.getElementById("previewList");
  list.innerHTML = "";
  images.forEach((img,i)=>{
    const container = document.createElement("div");
    const image = document.createElement("img");
    image.src = img;
    const btn = document.createElement("button");
    btn.textContent = "üóë Xo√°";
    btn.onclick = async ()=>{
      let doc = await getDoc(currentDocId);
      doc.images.splice(i,1);
      await updateDoc(doc);
      showPreviewImages(doc.images);
    };
    container.appendChild(image);
    container.appendChild(btn);
    list.appendChild(container);
  });
}
function finishCapture() {
  if (stream) stream.getTracks().forEach(t=>t.stop());
  document.getElementById("cameraPage").classList.add("hidden");
  document.getElementById("subjectPage").classList.remove("hidden");
  showDocs();
}
async function viewDoc(id) {
  const doc = await getDoc(id);
  currentDocId = id;
  document.getElementById("viewDocTitle").innerText = "üìë " + doc.name;
  const list = document.getElementById("photoList");
  list.innerHTML = "";
  doc.images.forEach((img,i)=>{
    const container = document.createElement("div");
    const image = document.createElement("img");
    image.src = img;
    const btn = document.createElement("button");
    btn.textContent = "üóë Xo√° ·∫£nh";
    btn.onclick = async ()=>{
      let d = await getDoc(currentDocId);
      d.images.splice(i,1);
      await updateDoc(d);
      viewDoc(currentDocId);
    };
    container.appendChild(image);
    container.appendChild(btn);
    list.appendChild(container);
  });
  document.getElementById("subjectPage").classList.add("hidden");
  document.getElementById("viewDocPage").classList.remove("hidden");
}
function backToDocs() {
  document.getElementById("viewDocPage").classList.add("hidden");
  document.getElementById("subjectPage").classList.remove("hidden");
}
function openDeleteDialog(id, name) {
  docToDelete = id;
  document.getElementById("deleteDocMessage").innerText =
    `B·∫°n c√≥ ch·∫Øc mu·ªën xo√° t√†i li·ªáu "${name}" kh√¥ng?`;
  document.getElementById("deleteDocDialog").classList.remove("hidden");
}
function closeDeleteDialog() {
  document.getElementById("deleteDocDialog").classList.add("hidden");
}
async function confirmDeleteDoc() {
  if (docToDelete !== null) {
    await deleteDoc(docToDelete);
    docToDelete = null;
    closeDeleteDialog();
    showDocs();
  }
}
</script>
</body>
</html>
