<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Web Há»c Táº­p</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f5f5f5;
  margin: 0;
  text-align: center;
}
h1,h2 { margin: 20px; }
button {
  margin: 4px;
  padding: 6px 14px;
  font-size: 14px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}
.subject, .doc, .task {
  background: #fff;
  border-radius: 12px;
  padding: 10px;
  margin: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
.subject:hover, .doc:hover { background: #ffe4ec; }
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px,1fr));
  gap: 10px;
  padding: 10px;
}
video, canvas {
  width: 100%;
  max-width: 400px;
  margin: 10px auto;
  border-radius: 12px;
  background: #000;
}
img {
  width: 90%;
  max-width: 280px;
  margin: 8px auto;
  border-radius: 10px;
  display:block;
}
.task-list {
  max-width: 400px;
  margin: 10px auto;
  text-align: left;
}
.task.overdue { background: #ffcccc; }
.hidden { display: none; }

/* Modal */
.modal {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
}
.modal-content {
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  text-align: center;
  width: 300px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}
.modal.hidden { display: none; }

#previewList img {
  width:120px;
  margin:5px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.3);
}
</style>
</head>
<body>

<!-- Trang chá»§ -->
<div id="home">
  <h1>Chá»n mÃ´n há»c</h1>
  <div class="grid">
    <div class="subject" onclick="openSubject('ToÃ¡n')">ğŸ“ ToÃ¡n</div>
    <div class="subject" onclick="openSubject('Ngá»¯ VÄƒn')">ğŸ“– Ngá»¯ VÄƒn</div>
    <div class="subject" onclick="openSubject('Lá»‹ch Sá»­')">ğŸ“œ Lá»‹ch Sá»­</div>
    <div class="subject" onclick="openSubject('Äá»‹a LÃ½')">ğŸŒ Äá»‹a LÃ½</div>
    <div class="subject" onclick="openSubject('Sinh há»c')">ğŸ§¬ Sinh há»c</div>
    <div class="subject" onclick="openSubject('HÃ³a há»c')">âš—ï¸ HÃ³a há»c</div>
  </div>
</div>

<!-- Trang mÃ´n há»c -->
<div id="subjectPage" class="hidden">
  <h1 id="subjectTitle"></h1>

  <!-- Quáº£n lÃ½ bÃ i táº­p -->
  <h2>ğŸ“’ BÃ i táº­p vá» nhÃ </h2>
  <input type="text" id="taskInput" placeholder="Nháº­p tÃªn bÃ i táº­p...">
  <input type="date" id="taskDeadline">
  <button onclick="addTask()">â• ThÃªm</button>
  <div id="taskList" class="task-list"></div>

  <!-- Quáº£n lÃ½ tÃ i liá»‡u -->
  <h2>ğŸ“‘ TÃ i liá»‡u</h2>
  <button onclick="openNewDocDialog()">â• Táº¡o tÃ i liá»‡u má»›i</button>
  <div id="docList" class="grid"></div>

  <br>
  <button onclick="goHome()">â¬… Quay láº¡i</button>
</div>

<!-- Trang chá»¥p áº£nh -->
<div id="cameraPage" class="hidden">
  <h2 id="docTitle"></h2>
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas" class="hidden"></canvas>
  <div>
    <button onclick="takePhoto()">ğŸ“¸ Chá»¥p</button>
    <button onclick="switchCamera()" id="switchBtn" class="hidden">ğŸ”„ Äá»•i camera</button>
    <button onclick="finishCapture()">âœ… Xong</button>
  </div>
  <div id="previewList"></div>
</div>

<!-- Trang xem tÃ i liá»‡u -->
<div id="viewDocPage" class="hidden">
  <h2 id="viewDocTitle"></h2>
  <div id="photoList"></div>
  <button onclick="backToDocs()">â¬… Quay láº¡i</button>
</div>

<!-- Modal nháº­p tÃªn tÃ i liá»‡u -->
<div id="newDocDialog" class="modal hidden">
  <div class="modal-content">
    <h3>ğŸ“‘ Nháº­p tÃªn tÃ i liá»‡u</h3>
    <input type="text" id="docNameInput" placeholder="TÃªn tÃ i liá»‡u...">
    <br><br>
    <button onclick="createDocument()">Táº¡o</button>
    <button onclick="closeDialog()">Há»§y</button>
  </div>
</div>

<!-- Modal xÃ¡c nháº­n xÃ³a -->
<div id="deleteDocDialog" class="modal hidden">
  <div class="modal-content">
    <h3>ğŸ—‘ XÃ³a tÃ i liá»‡u</h3>
    <p id="deleteDocMessage"></p>
    <button onclick="confirmDeleteDoc()">XÃ³a</button>
    <button onclick="closeDeleteDialog()">Há»§y</button>
  </div>
</div>

<script>
let currentSubject = "";
let currentDocId = null;
let stream = null;
let docToDelete = null;
let usingFront = true; // máº·c Ä‘á»‹nh dÃ¹ng cam trÆ°á»›c

/* IndexedDB */
function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open("StudyApp", 1);
    request.onupgradeneeded = (e) => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains("documents")) {
        db.createObjectStore("documents", { keyPath: "id", autoIncrement: true });
      }
    };
    request.onsuccess = (e) => resolve(e.target.result);
    request.onerror = (e) => reject(e.target.error);
  });
}
async function getAllDocs() {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction("documents", "readonly");
    const store = tx.objectStore("documents");
    const request = store.getAll();
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}
async function addDoc(doc) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction("documents", "readwrite");
    const store = tx.objectStore("documents");
    const request = store.add(doc);
    request.onsuccess = () => resolve(request.result);
    request.onerror = (e) => reject(e.target.error);
  });
}
async function updateDoc(doc) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction("documents", "readwrite");
    const store = tx.objectStore("documents");
    const request = store.put(doc);
    request.onsuccess = () => resolve();
    request.onerror = (e) => reject(e.target.error);
  });
}
async function deleteDoc(id) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction("documents", "readwrite");
    const store = tx.objectStore("documents");
    const request = store.delete(id);
    request.onsuccess = () => resolve();
    request.onerror = (e) => reject(e.target.error);
  });
}
async function getDoc(id) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction("documents", "readonly");
    const store = tx.objectStore("documents");
    const request = store.get(id);
    request.onsuccess = () => resolve(request.result);
    request.onerror = (e) => reject(e.target.error);
  });
}

/* MÃ´n há»c */
async function openSubject(name) {
  currentSubject = name;
  document.getElementById("subjectTitle").innerText = "MÃ´n: " + name;
  document.getElementById("home").classList.add("hidden");
  document.getElementById("subjectPage").classList.remove("hidden");
  loadTasks();
  showDocs();
}
function goHome() {
  document.getElementById("subjectPage").classList.add("hidden");
  document.getElementById("home").classList.remove("hidden");
}

/* BÃ i táº­p */
function addTask() {
  const taskText = document.getElementById("taskInput").value.trim();
  const deadline = document.getElementById("taskDeadline").value;
  if (!taskText || !deadline) { alert("Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin!"); return; }
  let tasks = JSON.parse(localStorage.getItem("tasks_" + currentSubject) || "[]");
  tasks.push({ text: taskText, deadline: deadline });
  localStorage.setItem("tasks_" + currentSubject, JSON.stringify(tasks));
  document.getElementById("taskInput").value = "";
  document.getElementById("taskDeadline").value = "";
  loadTasks();
}
function deleteTask(index) {
  let tasks = JSON.parse(localStorage.getItem("tasks_" + currentSubject) || "[]");
  tasks.splice(index, 1);
  localStorage.setItem("tasks_" + currentSubject, JSON.stringify(tasks));
  loadTasks();
}
function loadTasks() {
  let tasks = JSON.parse(localStorage.getItem("tasks_" + currentSubject) || "[]");
  const list = document.getElementById("taskList");
  list.innerHTML = "";
  const today = new Date().toISOString().split("T")[0];
  tasks.forEach((task,i) => {
    const div = document.createElement("div");
    div.classList.add("task");
    if (task.deadline < today) div.classList.add("overdue");
    div.innerHTML = `<b>${task.text}</b><br>Háº¡n: ${task.deadline} 
      <button onclick="deleteTask(${i})">âŒ</button>`;
    list.appendChild(div);
  });
}

/* TÃ i liá»‡u */
async function showDocs() {
  const list = document.getElementById("docList");
  list.innerHTML = "";
  const allDocs = await getAllDocs();
  const docs = allDocs.filter(d => d.subject === currentSubject);
  docs.forEach(doc=>{
    const div = document.createElement("div");
    div.className="doc";
    div.innerHTML = `
      <b>${doc.name}</b><br>
      (${doc.images.length} áº£nh)<br>
      <button onclick="viewDoc(${doc.id})">ğŸ‘ Xem</button>
      <button onclick="openDeleteDialog(${doc.id}, '${doc.name}')">ğŸ—‘ XoÃ¡</button>
    `;
    list.appendChild(div);
  });
}
function openNewDocDialog() {
  document.getElementById("docNameInput").value="";
  document.getElementById("newDocDialog").classList.remove("hidden");
}
function closeDialog() {
  document.getElementById("newDocDialog").classList.add("hidden");
}
async function createDocument() {
  const name = document.getElementById("docNameInput").value.trim();
  if (!name) return;
  closeDialog();
  currentDocId = await addDoc({subject: currentSubject, name: name, images: []});
  document.getElementById("docTitle").innerText = "TÃ i liá»‡u: " + name;
  document.getElementById("subjectPage").classList.add("hidden");
  document.getElementById("cameraPage").classList.remove("hidden");
  document.getElementById("previewList").innerHTML = ""; 
  openCamera();
}

/* Camera */
async function openCamera() {
  if (stream) stream.getTracks().forEach(t=>t.stop());
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: usingFront ? "user" : "environment" }
    });
    const video = document.getElementById("video");
    video.srcObject = stream;
    await video.play(); // fix iPhone video Ä‘en
    // Náº¿u trÃªn Ä‘iá»‡n thoáº¡i -> hiá»‡n nÃºt Ä‘á»•i camera
    if (/Mobi|Android|iPhone/i.test(navigator.userAgent)) {
      document.getElementById("switchBtn").classList.remove("hidden");
    } else {
      document.getElementById("switchBtn").classList.add("hidden");
    }
  } catch(err) {
    alert("KhÃ´ng thá»ƒ má»Ÿ camera: " + err);
  }
}
function switchCamera() {
  usingFront = !usingFront;
  openCamera();
}
async function takePhoto() {
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video,0,0);
  const imgData = canvas.toDataURL("image/jpeg", 0.7);
  let doc = await getDoc(currentDocId);
  doc.images.push(imgData);
  await updateDoc(doc);
  showPreviewImages(doc.images);
}
function showPreviewImages(images) {
  const list = document.getElementById("previewList");
  list.innerHTML = "";
  images.forEach((img,i)=>{
    const container = document.createElement("div");
    const image = document.createElement("img");
    image.src = img;
    const btn = document.createElement("button");
    btn.textContent = "ğŸ—‘ XoÃ¡";
    btn.onclick = async ()=>{
      let doc = await getDoc(currentDocId);
      doc.images.splice(i,1);
      await updateDoc(doc);
      showPreviewImages(doc.images);
    };
    container.appendChild(image);
    container.appendChild(btn);
    list.appendChild(container);
  });
}
function finishCapture() {
  if (stream) stream.getTracks().forEach(t=>t.stop());
  document.getElementById("cameraPage").classList.add("hidden");
  document.getElementById("subjectPage").classList.remove("hidden");
  showDocs();
}
async function viewDoc(id) {
  const doc = await getDoc(id);
  currentDocId = id;
  document.getElementById("viewDocTitle").innerText = "ğŸ“‘ " + doc.name;
  const list = document.getElementById("photoList");
  list.innerHTML = "";
  doc.images.forEach((img,i)=>{
    const container = document.createElement("div");
    const image = document.createElement("img");
    image.src = img;
    const btn = document.createElement("button");
    btn.textContent = "ğŸ—‘ XoÃ¡ áº£nh";
    btn.onclick = async ()=>{
      let d = await getDoc(currentDocId);
      d.images.splice(i,1);
      await updateDoc(d);
      viewDoc(currentDocId);
    };
    container.appendChild(image);
    container.appendChild(btn);
    list.appendChild(container);
  });
  document.getElementById("subjectPage").classList.add("hidden");
  document.getElementById("viewDocPage").classList.remove("hidden");
}
function backToDocs() {
  document.getElementById("viewDocPage").classList.add("hidden");
  document.getElementById("subjectPage").classList.remove("hidden");
}
function openDeleteDialog(id, name) {
  docToDelete = id;
  document.getElementById("deleteDocMessage").innerText =
    `Báº¡n cÃ³ cháº¯c muá»‘n xoÃ¡ tÃ i liá»‡u "${name}" khÃ´ng?`;
  document.getElementById("deleteDocDialog").classList.remove("hidden");
}
function closeDeleteDialog() {
  document.getElementById("deleteDocDialog").classList.add("hidden");
  docToDelete = null;
}
async function confirmDeleteDoc() {
  if (docToDelete !== null) {
    await deleteDoc(docToDelete);
    showDocs();
  }
  closeDeleteDialog();
}
</script>
</body>
</html>
